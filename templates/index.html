<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>虚拟机配置表单</title>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background-color: #f6f6f6; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 30px auto; background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    fieldset { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 20px; }
    legend { font-weight: bold; padding: 0 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; outline: none; }
    .folder-input { display: flex; align-items: center; }
    .folder-input span { padding: 8px; background-color: #eee; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px; }
    .folder-input input { border-radius: 0 4px 4px 0; border-left: none; }
    input[type="checkbox"] { transform: scale(1.2); margin-right: 5px; cursor: pointer; }
    button { cursor: pointer; padding: 8px 16px; background-color: #4CAF50; border: none; border-radius: 4px; color: #fff; font-size: 14px; }
    button:hover { background-color: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    thead tr { background-color: #f2f2f2; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .delete-btn { background-color: #f44336; margin-left: 10px; }
    .delete-btn:hover { background-color: #e53935; }
    #progressModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #progressModal .modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; width: 300px; }
    #progressBar { width: 100%; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; }
    #progressBar div { height: 20px; width: 0; background: #4caf50; text-align: center; color: #fff; line-height: 20px; }
    #errorMessage { background: #f44336; color: #fff; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: none; }
    #passwordsDisplay { background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>虚拟机配置表单</h2>
  <div id="errorMessage"></div>
  <form id="vmForm" method="post" action="/submit">
    <!-- vCenter 连接信息 -->
    <fieldset>
      <legend>vCenter 连接信息</legend>
      <div class="form-group"><label for="vcenter_hostname">vCenter 主机名</label><input type="text" id="vcenter_hostname" name="vcenter_hostname" required value="10.0.200.100"></div>
      <div class="form-group"><label for="vcenter_username">vCenter 用户名</label><input type="text" id="vcenter_username" name="vcenter_username" required value="administrator@vsphere.local"></div>
      <div class="form-group"><label for="vcenter_password">vCenter 密码</label><input type="text" id="vcenter_password" name="vcenter_password" required value="Leinao@323"></div>
      <div class="form-group"><label for="datacenter_name">数据中心名称</label><input type="text" id="datacenter_name" name="datacenter_name" required value="Leinao"></div>
      <div class="form-group"><label for="datastore_name">存储名称</label><select id="datastore_name" name="datastore_name" required><option value="104-ShanYan-60T">104-ShanYan-60T</option><option value="SandStone-28T">SandStone-28T</option><option value="ShanYan-SSD" selected>ShanYan-SSD</option></select></div>
      <div class="form-group"><label for="vm_folder_suffix">虚机文件夹</label><div class="folder-input"><span>/vm/</span><input type="text" id="vm_folder_suffix" name="vm_folder_suffix" required placeholder="其他" value="其他"></div></div>
    </fieldset>

    <!-- 虚机信息 -->
    <fieldset><legend>虚机信息</legend><table id="vmTable"><thead><tr><th>虚机名称</th><th>系统 Hostname</th><th>虚机 IP</th><th>操作</th></tr></thead><tbody><tr><td><input type="text" name="vmName" placeholder="test-vm2"></td><td><input type="text" name="vmHostname" placeholder="guest-hostname"></td><td><input type="text" name="vmIP" placeholder="10.0.101.190"></td><td><button type="button" class="delete-btn" onclick="deleteRow(this)">删除</button></td></tr></tbody></table><button type="button" id="addVmBtn">+ 添加虚机</button></fieldset>

    <!-- 模板与硬件配置 -->
    <fieldset><legend>模板与硬件配置</legend><div class="form-group"><label for="template">模板名称</label><select id="template" name="template" required><option value="centos7.9-consul模板">centos7.9-consul模板</option><option value="openEuler22.03模板">openEuler22.03模板</option><option value="ubuntu-20.04模板" selected>ubuntu-20.04模板</option><option value="T4集群-Centos模板">T4集群-Centos模板</option></select></div><div class="form-group"><label for="num_cpus">CPU 数量</label><input type="number" id="num_cpus" name="num_cpus" required value="2"></div><div class="form-group"><label for="memory_gb">内存 (GB)</label><input type="number" id="memory_gb" name="memory_gb" required value="4"></div><div class="form-group"><label for="disk_size_gb">磁盘大小 (GB)</label><input type="number" id="disk_size_gb" name="disk_size_gb" required value="400"></div></fieldset>

    <!-- 网络配置 -->
    <fieldset><legend>网络配置</legend><div class="form-group"><label for="network_name">网络适配器名称</label><select id="network_name" name="network_name" required><option value="vlan100-生产">vlan100-生产</option><option value="vlan101-测试" selected>vlan101-测试</option><option value="vlan102-开发">vlan102-开发</option></select></div><div class="form-group"><label for="netmask">子网掩码</label><input type="text" id="netmask" name="netmask" required value="255.255.255.0"></div><div class="form-group"><label for="gateway">网关</label><input type="text" id="gateway" name="gateway" required value="10.0.101.1"></div><div class="form-group"><label for="dns_servers">DNS 服务器</label><input type="text" id="dns_servers" name="dns_servers" placeholder="8.8.8.8,8.8.4.4"></div></fieldset>

    <!-- 集群配置 -->
    <fieldset><legend>集群配置</legend><div class="form-group"><label for="cluster">集群</label><select id="cluster" name="cluster" required><option value="Leinao-CPU集群" selected>Leinao-CPU集群</option><option value="Leinao-GPU集群">Leinao-GPU集群</option><option value="Leinao-T4集群">Leinao-T4集群</option></select></div><div class="form-group"><label for="resource_pool">资源池</label><input type="text" id="resource_pool" name="resource_pool" required value="Resources"></div><div class="form-group"><input type="checkbox" id="use_esxi" name="use_esxi"><label for="use_esxi">使用指定 ESXi 主机</label></div><div class="form-group" id="esxi_hostname_group" style="display: none;"><label for="esxi_hostname">ESXi 主机名</label><input type="text" id="esxi_hostname" name="esxi_hostname" placeholder="10.0.200.88"></div></fieldset>

    <!-- 隐藏字段 -->
    <input type="hidden" id="vm_names" name="vm_names"><input type="hidden" id="vm_ips" name="vm_ips"><input type="hidden" id="vm_folder" name="vm_folder">
    <div style="text-align: center;"><button type="submit">提交配置</button></div>
  </form>
  <pre id="passwordsDisplay"></pre>
</div>

<!-- 进度条遮罩 -->
<div id="progressModal"><div class="modal-content"><h3>任务执行中...</h3><div id="progressBar"><div></div></div></div></div>

<script>
  document.getElementById('use_esxi').addEventListener('change', function() {
    document.getElementById('esxi_hostname_group').style.display = this.checked ? 'block' : 'none';
  });
  function deleteRow(btn) { btn.parentNode.parentNode.remove(); }
  document.getElementById('addVmBtn').addEventListener('click', function() {
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td><input type="text" name="vmName" placeholder="test-vmX"></td>
      <td><input type="text" name="vmHostname" placeholder="guest-hostname"></td>
      <td><input type="text" name="vmIP" placeholder="10.0.101.X"></td>
      <td><button type="button" class="delete-btn" onclick="deleteRow(this)">删除</button></td>
    `;
    document.querySelector('#vmTable tbody').appendChild(newRow);
  });
  document.getElementById('vmForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const errorDiv = document.getElementById('errorMessage'); errorDiv.style.display = 'none'; errorDiv.innerText = '';
    const progressModal = document.getElementById('progressModal'); progressModal.style.display = 'flex';
    const progressBar = document.getElementById('progressBar').firstElementChild;
    progressBar.style.width = '0%'; progressBar.innerText = '0%';
    let progress = 0;
    const interval = setInterval(() => { progress = Math.min(progress+10,90); progressBar.style.width = progress+'%'; progressBar.innerText = progress+'%'; },500);
    const formData = new FormData(document.getElementById('vmForm'));
    const folderSuffix = formData.get('vm_folder_suffix'); formData.set('vm_folder','/vm/'+folderSuffix); formData.delete('vm_folder_suffix');
    const gb = parseInt(formData.get('memory_gb')||'0',10); formData.set('memory_mb',gb*1024); formData.delete('memory_gb');
    const dns = formData.get('dns_servers')?.trim(); if(dns) formData.set('dns_servers',dns);
    const names=[],hostnames=[],ips=[];
    document.querySelectorAll('input[name="vmName"]').forEach((e,i)=>{ if(e.value.trim()){names.push(e.value.trim());} const hn = document.querySelectorAll('input[name="vmHostname"]')[i].value.trim(); if(hn) hostnames.push(hn); const ip = document.querySelectorAll('input[name="vmIP"]')[i].value.trim(); if(ip) ips.push(ip);} );
    formData.set('vm_names',names.join(',')); formData.set('hostnames',hostnames.join(',')); formData.set('vm_ips',ips.join(','));
    fetch(this.action,{method:'POST',body:formData})
    .then(r=>{ clearInterval(interval); if(!r.ok){return r.json().then(d=>{throw new Error(d.details||'未知错误');});} return r.json(); })
    .then(data=>{
      progressBar.style.width='100%'; progressBar.innerText='100%';
      // 显示密码列表
      const pwBlock=document.getElementById('passwordsDisplay');
      pwBlock.textContent = Object.entries(data.passwords).map(([vm,p])=>vm+': '+p).join('\n');
      pwBlock.style.display = 'block';
      setTimeout(()=>{ progressModal.style.display='none'; },1000);
    })
    .catch(err=>{ clearInterval(interval); document.getElementById('progressModal').style.display='none'; errorDiv.style.display='block'; errorDiv.innerText='任务执行失败：'+err.message; });
  });
</script>
</body>
</html>

