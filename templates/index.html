<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>è™šæ‹Ÿæœºè‡ªåŠ¨åŒ–éƒ¨ç½²å¹³å°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f8fafc;
      line-height: 1.6;
      color: #334155;
    }
    
    .container { 
      max-width: 1200px; 
      margin: 20px auto; 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .header {
      background: #1e293b;
      color: white;
      padding: 2rem;
      text-align: center;
    }
    
    .header h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .header p {
      font-size: 1rem;
      opacity: 0.8;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: 600px;
    }
    
    .sidebar {
      background: #f1f5f9;
      border-right: 1px solid #e2e8f0;
      padding: 1.5rem;
    }
    
    .nav-item {
      display: block;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      text-decoration: none;
      color: #475569;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .nav-item:hover {
      background: #e2e8f0;
      color: #1e293b;
    }
    
    .nav-item.active {
      background: #3b82f6;
      color: white;
    }
    
    .content-area {
      padding: 2rem;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .form-grid {
      display: grid;
      gap: 1.5rem;
    }
    
    .form-grid.two-col {
      grid-template-columns: 1fr 1fr;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #374151;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-help {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .strategy-cards {
      display: grid;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .strategy-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    
    .strategy-card:hover {
      border-color: #3b82f6;
    }
    
    .strategy-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .strategy-card input[type="radio"] {
      position: absolute;
      opacity: 0;
    }
    
    .strategy-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1f2937;
    }
    
    .strategy-desc {
      color: #6b7280;
      font-size: 0.875rem;
    }
    
    .esxi-config {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e5e7eb;
      display: none;
    }
    
    .esxi-config.show {
      display: block;
    }
    
    .vm-table-wrapper {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .vm-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .vm-table th {
      background: #f8fafc;
      padding: 0.875rem;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .vm-table td {
      padding: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: middle;
    }
    
    .vm-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .vm-table input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-danger {
      background: #ef4444;
      color: white;
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
    }
    
    .btn-danger:hover {
      background: #dc2626;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    
    .alert-info {
      background: #dbeafe;
      border: 1px solid #93c5fd;
      color: #1e40af;
    }
    
    .alert-warning {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
    }
    
    .alert-error {
      background: #fee2e2;
      border: 1px solid #f87171;
      color: #991b1b;
      display: none;
    }
    
    .alert-success {
      background: #d1fae5;
      border: 1px solid #34d399;
      color: #065f46;
    }
    
    .progress-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .progress-modal {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      text-align: center;
      min-width: 300px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin: 1rem 0;
    }
    
    .progress-fill {
      height: 100%;
      background: #3b82f6;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-auto {
      background: #d1fae5;
      color: #065f46;
    }
    
    .status-single {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .status-multi {
      background: #fef3c7;
      color: #92400e;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .password-display {
      background: #f0fdf4;
      border: 1px solid #22c55e;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1.5rem;
      display: none;
    }
    
    .password-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: white;
      border-radius: 6px;
      border: 1px solid #dcfce7;
    }
    
    .password-vm {
      font-weight: 600;
      color: #166534;
    }
    
    .password-value {
      font-family: 'Courier New', monospace;
      background: #166534;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .log-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .log-status {
      font-size: 0.8125rem;
      color: #64748b;
    }

    .log-container {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #0f172a;
      padding: 1rem;
      min-height: 260px;
      max-height: 420px;
      overflow-y: auto;
      color: #e2e8f0;
      font-family: 'Fira Code', 'Courier New', monospace;
      font-size: 0.8125rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .log-toolbar-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
      }
      
      .form-grid.two-col {
        grid-template-columns: 1fr;
      }
    }
    
    .collapsed-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .collapsed-info h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.875rem;
      color: #475569;
    }
    
    .collapsed-info p {
      margin: 0;
      font-size: 0.875rem;
      color: #64748b;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>è™šæ‹Ÿæœºè‡ªåŠ¨åŒ–éƒ¨ç½²å¹³å°</h1>
    <p>åŸºäº VMware vSphere çš„ä¼ä¸šçº§è™šæœºéƒ¨ç½²è§£å†³æ–¹æ¡ˆ</p>
  </div>
  
  <div class="main-content">
    <nav class="sidebar">
      <button class="nav-item active" onclick="showSection('basic')">åŸºç¡€é…ç½®</button>
      <button class="nav-item" onclick="showSection('hardware')">ç¡¬ä»¶é…ç½®</button>
      <button class="nav-item" onclick="showSection('network')">ç½‘ç»œé…ç½®</button>
      <button class="nav-item" onclick="showSection('scheduling')">è°ƒåº¦ç­–ç•¥</button>
      <button class="nav-item" onclick="showSection('vms')">è™šæ‹Ÿæœºåˆ—è¡¨</button>
      <button class="nav-item" onclick="showSection('advanced')">é«˜çº§è®¾ç½®</button>
      <button class="nav-item" onclick="showSection('logs')">è¿è¡Œæ—¥å¿—</button>
    </nav>

    <div class="content-area">
      <form id="vmForm" method="post" action="/submit">
        <div id="errorMessage" class="alert alert-error"></div>
        
        <!-- åŸºç¡€é…ç½® -->
        <section id="basic" class="section active">
          <h2 class="section-title">åŸºç¡€é…ç½®</h2>
          
          <div class="collapsed-info">
            <h4>vCenter è¿æ¥ä¿¡æ¯</h4>
            <p>ä½¿ç”¨é¢„é…ç½®çš„ vCenter æœåŠ¡å™¨ (10.0.200.100) å’Œæ•°æ®ä¸­å¿ƒ (Leinao)</p>
          </div>
          
          <div class="form-grid two-col">
            <div class="form-group">
              <label for="datastore_name">å­˜å‚¨æ•°æ®å­˜å‚¨</label>
              <select id="datastore_name" name="datastore_name" required>
                <option value="ShanYan-SSD" selected>ShanYan-SSD</option>
                <option value="104-ShanYan-60T">104-ShanYan-60T</option>
                <option value="SandStone-28T">SandStone-28T</option>
              </select>
              <div class="form-help">é€‰æ‹©è™šæ‹Ÿæœºç£ç›˜æ–‡ä»¶çš„å­˜å‚¨ä½ç½®</div>
            </div>
            
            <div class="form-group">
              <label for="vm_folder_suffix">éƒ¨ç½²ç›®å½•</label>
              <input type="text" id="vm_folder_suffix" name="vm_folder_suffix" required value="å…¶ä»–">
              <div class="form-help">è™šæ‹Ÿæœºå°†éƒ¨ç½²åˆ° /vm/{ç›®å½•å} ä¸‹</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="template">è™šæ‹Ÿæœºæ¨¡æ¿</label>
            <select id="template" name="template" required>
              <option value="openEuler22.03æ¨¡æ¿" selected>openEuler 22.03</option>
              <option value="ubuntu-20.04æ¨¡æ¿">Ubuntu 20.04 LTS</option>
              <option value="ubuntu-22.04æ¨¡æ¿">Ubuntu 22.04 LTS</option>
              <option value="debian12-æ¨¡æ¿">Debian 12</option>
            </select>
            <div class="form-help">é€‰æ‹©è™šæ‹Ÿæœºçš„æ“ä½œç³»ç»Ÿæ¨¡æ¿</div>
          </div>
        </section>
        
        <!-- ç¡¬ä»¶é…ç½® -->
        <section id="hardware" class="section">
          <h2 class="section-title">ç¡¬ä»¶é…ç½®</h2>
          
          <div class="form-grid two-col">
            <div class="form-group">
              <label for="num_cpus">CPU æ ¸å¿ƒæ•°</label>
              <input type="number" id="num_cpus" name="num_cpus" required value="2" min="1" max="32">
            </div>
            
            <div class="form-group">
              <label for="memory_gb">å†…å­˜å¤§å° (GB)</label>
              <input type="number" id="memory_gb" name="memory_gb" required value="4" min="1" max="256">
            </div>
          </div>
          
          <div class="form-group">
            <label for="disk_size_gb">ç£ç›˜å¤§å° (GB)</label>
            <input type="number" id="disk_size_gb" name="disk_size_gb" required value="400" min="20" max="2000">
            <div class="form-help">è™šæ‹Ÿæœºç³»ç»Ÿç›˜å¤§å°ï¼Œå»ºè®®ä¸å°‘äº100GB</div>
          </div>
        </section>
        
        <!-- ç½‘ç»œé…ç½® -->
        <section id="network" class="section">
          <h2 class="section-title">ç½‘ç»œé…ç½®</h2>
          
          <div class="form-grid two-col">
            <div class="form-group">
              <label for="network_name">ç½‘ç»œé€‚é…å™¨</label>
              <select id="network_name" name="network_name" required>
                <option value="vlan101-æµ‹è¯•" selected>VLAN101 - æµ‹è¯•ç½‘ç»œ</option>
                <option value="vlan100-ç”Ÿäº§">VLAN100 - ç”Ÿäº§ç½‘ç»œ</option>
                <option value="vlan102-å¼€å‘">VLAN102 - å¼€å‘ç½‘ç»œ</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="gateway">ç½‘å…³åœ°å€</label>
              <input type="text" id="gateway" name="gateway" required value="10.0.101.1">
            </div>
          </div>
          
          <div class="form-grid two-col">
            <div class="form-group">
              <label for="netmask">å­ç½‘æ©ç </label>
              <input type="text" id="netmask" name="netmask" required value="255.255.255.0">
            </div>
            
            <div class="form-group">
              <label for="dns_servers">DNS æœåŠ¡å™¨</label>
              <input type="text" id="dns_servers" name="dns_servers" value="223.5.5.5" placeholder="å¤šä¸ªDNSç”¨é€—å·åˆ†éš”">
            </div>
          </div>
        </section>
        
        <!-- è°ƒåº¦ç­–ç•¥ -->
        <section id="scheduling" class="section">
          <h2 class="section-title">è°ƒåº¦ç­–ç•¥</h2>
          
          <div class="strategy-cards">
            <div class="strategy-card selected" data-strategy="cluster">
              <input type="radio" id="strategy_cluster" name="scheduling_strategy" value="cluster" checked>
              <div class="strategy-title">é›†ç¾¤è‡ªåŠ¨è°ƒåº¦</div>
              <div class="strategy-desc">ç”± vSphere æ ¹æ®èµ„æºä½¿ç”¨æƒ…å†µè‡ªåŠ¨é€‰æ‹©æœ€ä½³ESXiä¸»æœºï¼Œå®ç°è´Ÿè½½å‡è¡¡</div>
              
              <div class="esxi-config">
                <div class="form-grid two-col">
                  <div class="form-group">
                    <label for="cluster">è®¡ç®—é›†ç¾¤</label>
                    <select id="cluster" name="cluster" required>
                      <option value="Leinao-CPUé›†ç¾¤" selected>Leinao-CPUé›†ç¾¤</option>
                      <option value="Leinao-GPUé›†ç¾¤">Leinao-GPUé›†ç¾¤</option>
                      <option value="Leinao-T4é›†ç¾¤">Leinao-T4é›†ç¾¤</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="resource_pool">èµ„æºæ± </label>
                    <input type="text" id="resource_pool" name="resource_pool" required value="Resources">
                  </div>
                </div>
              </div>
            </div>
            
            <div class="strategy-card" data-strategy="single-esxi">
              <input type="radio" id="strategy_single" name="scheduling_strategy" value="single-esxi">
              <div class="strategy-title">æŒ‡å®šå•å°ESXiä¸»æœº</div>
              <div class="strategy-desc">å°†æ‰€æœ‰è™šæ‹Ÿæœºéƒ¨ç½²åˆ°åŒä¸€å°ESXiä¸»æœºï¼Œé€‚ç”¨äºç‰¹å®šç¡¬ä»¶éœ€æ±‚</div>
              
              <div class="esxi-config">
                <div class="form-group">
                  <label for="single_esxi_hostname">ESXi ä¸»æœºåœ°å€</label>
                  <input type="text" id="single_esxi_hostname" name="single_esxi_hostname" placeholder="ä¾‹å¦‚: 10.0.200.28">
                </div>
                
                <div class="alert alert-info">
                  <strong>ä¸»æœºå‚è€ƒ:</strong><br>
                  â€¢ CPUé›†ç¾¤: 10.0.200.11-18<br>
                  â€¢ GPUé›†ç¾¤: 10.0.200.28-32<br>
                  â€¢ T4é›†ç¾¤: 192.168.7.11-14
                </div>
              </div>
            </div>
            
            <div class="strategy-card" data-strategy="multi-esxi">
              <input type="radio" id="strategy_multi" name="scheduling_strategy" value="multi-esxi">
              <div class="strategy-title">ä¸ºæ¯ä¸ªVMæŒ‡å®šä¸åŒä¸»æœº</div>
              <div class="strategy-desc">ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºå•ç‹¬æŒ‡å®šESXiä¸»æœºï¼Œå®ç°ç²¾ç¡®çš„èµ„æºåˆ†é…</div>
              
              <div class="esxi-config">
                <div class="form-group">
                  <label for="multi_esxi_hostnames">ESXi ä¸»æœºåˆ—è¡¨</label>
                  <textarea id="multi_esxi_hostnames" name="multi_esxi_hostnames" rows="4" 
                            placeholder="æ¯è¡Œä¸€ä¸ªESXiä¸»æœºIPï¼ŒæŒ‰VMé¡ºåºå¯¹åº”ï¼š&#10;10.0.200.28&#10;10.0.200.29&#10;192.168.7.11"></textarea>
                  <div class="form-help">ä¸»æœºæ•°é‡å¿…é¡»ä¸è™šæ‹Ÿæœºæ•°é‡ä¸€è‡´</div>
                </div>
              </div>
            </div>
          </div>
        </section>
        
        <!-- è™šæ‹Ÿæœºåˆ—è¡¨ -->
        <section id="vms" class="section">
          <h2 class="section-title">è™šæ‹Ÿæœºåˆ—è¡¨</h2>
          
          <div class="vm-table-wrapper">
            <table class="vm-table" id="vmTable">
              <thead>
                <tr>
                  <th width="8%">åºå·</th>
                  <th width="25%">è™šæœºåç§°</th>
                  <th width="22%">ä¸»æœºå</th>
                  <th width="20%">IPåœ°å€</th>
                  <th width="20%">è°ƒåº¦çŠ¶æ€</th>
                  <th width="10%">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td><input type="text" name="vmName" placeholder="test-vm1"></td>
                  <td><input type="text" name="vmHostname" placeholder="hostname1"></td>
                  <td><input type="text" name="vmIP" placeholder="10.0.101.190"></td>
                  <td><span class="status-badge status-auto">é›†ç¾¤è‡ªåŠ¨è°ƒåº¦</span></td>
                  <td><button type="button" class="btn btn-danger" onclick="deleteRow(this)">åˆ é™¤</button></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div style="margin-top: 1rem;">
            <button type="button" id="addVmBtn" class="btn btn-success">+ æ·»åŠ è™šæ‹Ÿæœº</button>
          </div>
        </section>
        
        <!-- é«˜çº§è®¾ç½® -->
        <section id="advanced" class="section">
          <h2 class="section-title">é«˜çº§è®¾ç½®</h2>

          <div class="collapsed-info">
            <h4>éšè—çš„ç³»ç»Ÿé…ç½®</h4>
            <p>ä»¥ä¸‹é…ç½®å·²è‡ªåŠ¨è®¾ç½®ï¼Œé€šå¸¸ä¸éœ€è¦ä¿®æ”¹</p>
          </div>
          
          <!-- éšè—çš„å­—æ®µ -->
          <input type="hidden" name="vcenter_hostname" value="10.0.200.100">
          <input type="hidden" name="vcenter_username" value="administrator@vsphere.local">
          <input type="hidden" name="vcenter_password" value="Leinao@323">
          <input type="hidden" name="datacenter_name" value="Leinao">
          <input type="hidden" name="dns_suffix" value="">
          
          <!-- åŠ¨æ€ç”Ÿæˆçš„éšè—å­—æ®µ -->
          <input type="hidden" id="vm_names" name="vm_names">
          <input type="hidden" id="vm_ips" name="vm_ips">
          <input type="hidden" id="vm_folder" name="vm_folder">
          <input type="hidden" id="esxi_hostnames" name="esxi_hostnames">
        </section>

        <section id="logs" class="section" data-wizard="false">
          <h2 class="section-title">è¿è¡Œæ—¥å¿—</h2>
          <div class="log-toolbar">
            <div class="log-toolbar-buttons">
              <button type="button" class="btn btn-secondary" onclick="fetchLogs(true)">åˆ·æ–°æ—¥å¿—</button>
              <button type="button" id="toggleAutoRefresh" class="btn btn-secondary" onclick="toggleAutoRefresh()">å¼€å¯è‡ªåŠ¨åˆ·æ–°</button>
            </div>
            <div id="logStatus" class="log-status">æœ€æ–°æ—¥å¿—å¯åœ¨æ­¤æŸ¥çœ‹éƒ¨ç½²è¿‡ç¨‹</div>
          </div>
          <div id="logContent" class="log-container">æš‚æ— æ—¥å¿—è¾“å‡º</div>
        </section>

        <div class="navigation-buttons">
          <button type="button" id="prevBtn" class="btn btn-secondary" onclick="previousSection()">ä¸Šä¸€æ­¥</button>
          <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextSection()">ä¸‹ä¸€æ­¥</button>
          <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">å¼€å§‹éƒ¨ç½²</button>
        </div>
      </form>
      
      <div id="passwordsDisplay" class="password-display"></div>
    </div>
  </div>
</div>

<!-- è¿›åº¦æ¡ -->
<div id="progressContainer" class="progress-container">
  <div class="progress-modal">
    <h3>æ­£åœ¨éƒ¨ç½²è™šæ‹Ÿæœº...</h3>
    <p>è¯·è€å¿ƒç­‰å¾…ï¼Œç³»ç»Ÿæ­£åœ¨ä¸ºæ‚¨åˆ›å»ºè™šæ‹Ÿæœº</p>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div id="progressText">0%</div>
  </div>
</div>

<script>
  let currentSection = 0;
  let vmCounter = 1;
  const sections = ['basic', 'hardware', 'network', 'scheduling', 'vms', 'advanced'];
  let logInterval = null;
  let isAutoRefreshing = false;

  // å¯¼èˆªåŠŸèƒ½
  function showSection(sectionId) {
    // éšè—æ‰€æœ‰section
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    // æ˜¾ç¤ºç›®æ ‡section
    document.getElementById(sectionId).classList.add('active');
    const targetNav = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
    if (targetNav) {
      targetNav.classList.add('active');
    }

    const wizardIndex = sections.indexOf(sectionId);
    if (wizardIndex !== -1) {
      currentSection = wizardIndex;
    }

    updateNavigationButtons();

    if (sectionId === 'logs') {
      fetchLogs(true);
    }
  }
  
  function nextSection() {
    if (currentSection < sections.length - 1) {
      currentSection++;
      showSection(sections[currentSection]);
    }
  }
  
  function previousSection() {
    if (currentSection > 0) {
      currentSection--;
      showSection(sections[currentSection]);
    }
  }
  
  function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const activeSection = document.querySelector('.section.active');
    const isWizardSection = !activeSection || activeSection.dataset.wizard !== 'false';

    if (!isWizardSection) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'none';
      return;
    }

    prevBtn.style.display = currentSection > 0 ? 'block' : 'none';
    nextBtn.style.display = currentSection < sections.length - 1 ? 'block' : 'none';
    submitBtn.style.display = currentSection === sections.length - 1 ? 'block' : 'none';
  }
  
  // è°ƒåº¦ç­–ç•¥åˆ‡æ¢
  document.querySelectorAll('.strategy-card').forEach(card => {
    card.addEventListener('click', function() {
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.strategy-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('.esxi-config').forEach(c => c.classList.remove('show'));
      
      // é€‰ä¸­å½“å‰å¡ç‰‡
      this.classList.add('selected');
      const radio = this.querySelector('input[type="radio"]');
      radio.checked = true;
      
      // æ˜¾ç¤ºå¯¹åº”çš„é…ç½®
      const config = this.querySelector('.esxi-config');
      if (config) {
        config.classList.add('show');
      }
      
      updateVmTableDisplay();
    });
  });
  
  // æ›´æ–°VMè¡¨æ ¼æ˜¾ç¤º
  function updateVmTableDisplay() {
    const strategy = document.querySelector('input[name="scheduling_strategy"]:checked').value;
    const statusCells = document.querySelectorAll('.vm-table tbody .status-badge');
    
    statusCells.forEach((cell, index) => {
      cell.className = 'status-badge';
      if (strategy === 'cluster') {
        cell.classList.add('status-auto');
        cell.textContent = 'é›†ç¾¤è‡ªåŠ¨è°ƒåº¦';
      } else if (strategy === 'single-esxi') {
        cell.classList.add('status-single');
        const host = document.getElementById('single_esxi_hostname').value;
        cell.textContent = host ? `å•æœº: ${host}` : 'å¾…æŒ‡å®šä¸»æœº';
      } else if (strategy === 'multi-esxi') {
        cell.classList.add('status-multi');
        cell.textContent = `ä¸»æœº ${index + 1}`;
      }
    });
  }
  
  // ç›‘å¬ESXiä¸»æœºè¾“å…¥å˜åŒ–
  document.getElementById('single_esxi_hostname').addEventListener('input', updateVmTableDisplay);
  
  document.getElementById('multi_esxi_hostnames').addEventListener('input', function() {
    if (document.querySelector('input[name="scheduling_strategy"]:checked').value === 'multi-esxi') {
      updateMultiEsxiDisplay();
    }
  });
  
  function updateMultiEsxiDisplay() {
    const textarea = document.getElementById('multi_esxi_hostnames');
    const hosts = textarea.value.split('\n').map(h => h.trim()).filter(h => h);
    const statusCells = document.querySelectorAll('.vm-table tbody .status-badge');
    
    statusCells.forEach((cell, index) => {
      if (hosts[index]) {
        cell.className = 'status-badge status-auto';
        cell.textContent = hosts[index];
      } else {
        cell.className = 'status-badge status-multi';
        cell.textContent = `ä¸»æœº ${index + 1} (æœªæŒ‡å®š)`;
      }
    });
  }
  
  // VMè¡¨æ ¼æ“ä½œ
  function deleteRow(btn) {
    if (document.querySelectorAll('#vmTable tbody tr').length <= 1) {
      showError('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å°è™šæ‹Ÿæœº');
      return;
    }
    btn.closest('tr').remove();
    updateRowNumbers();
    updateVmTableDisplay();
  }
  
  function updateRowNumbers() {
    const rows = document.querySelectorAll('#vmTable tbody tr');
    rows.forEach((row, index) => {
      row.cells[0].textContent = index + 1;
    });
    vmCounter = rows.length;
  }
  
  document.getElementById('addVmBtn').addEventListener('click', function() {
    vmCounter++;
    const tbody = document.querySelector('#vmTable tbody');
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td>${vmCounter}</td>
      <td><input type="text" name="vmName" placeholder="test-vm${vmCounter}"></td>
      <td><input type="text" name="vmHostname" placeholder="hostname${vmCounter}"></td>
      <td><input type="text" name="vmIP" placeholder="10.0.101.${190 + vmCounter - 1}"></td>
      <td><span class="status-badge status-auto">é›†ç¾¤è‡ªåŠ¨è°ƒåº¦</span></td>
      <td><button type="button" class="btn btn-danger" onclick="deleteRow(this)">åˆ é™¤</button></td>
    `;
    tbody.appendChild(newRow);
    updateVmTableDisplay();
  });
  
  // è¡¨å•æäº¤
  document.getElementById('vmForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    // éªŒè¯è¡¨å•
    if (!validateForm()) {
      return;
    }
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    showProgress();
    
    // å‡†å¤‡è¡¨å•æ•°æ®
    const formData = new FormData();
    
    // åŸºç¡€é…ç½®
    formData.set('vcenter_hostname', '10.0.200.100');
    formData.set('vcenter_username', 'administrator@vsphere.local');
    formData.set('vcenter_password', 'Leinao@323');
    formData.set('datacenter_name', 'Leinao');
    formData.set('datastore_name', document.getElementById('datastore_name').value);
    formData.set('vm_folder', '/vm/' + document.getElementById('vm_folder_suffix').value);
    formData.set('template', document.getElementById('template').value);
    
    // ç¡¬ä»¶é…ç½®
    formData.set('num_cpus', document.getElementById('num_cpus').value);
    formData.set('memory_mb', parseInt(document.getElementById('memory_gb').value) * 1024);
    formData.set('disk_size_gb', document.getElementById('disk_size_gb').value);
    
    // ç½‘ç»œé…ç½®
    formData.set('network_name', document.getElementById('network_name').value);
    formData.set('netmask', document.getElementById('netmask').value);
    formData.set('gateway', document.getElementById('gateway').value);
    formData.set('dns_servers', document.getElementById('dns_servers').value);
    formData.set('dns_suffix', '');
    
    // è°ƒåº¦ç­–ç•¥
    const strategy = document.querySelector('input[name="scheduling_strategy"]:checked').value;
    formData.set('scheduling_strategy', strategy);
    
    if (strategy === 'cluster') {
      formData.set('cluster', document.getElementById('cluster').value);
      formData.set('resource_pool', document.getElementById('resource_pool').value);
    } else if (strategy === 'single-esxi') {
      formData.set('esxi_hostnames', document.getElementById('single_esxi_hostname').value);
      formData.set('cluster', '');
      formData.set('resource_pool', '');
    } else if (strategy === 'multi-esxi') {
      const hosts = document.getElementById('multi_esxi_hostnames').value
        .split('\n').map(h => h.trim()).filter(h => h).join(',');
      formData.set('esxi_hostnames', hosts);
      formData.set('cluster', '');
      formData.set('resource_pool', '');
    }
    
    // VMåˆ—è¡¨
    const names = [], hostnames = [], ips = [];
    document.querySelectorAll('input[name="vmName"]').forEach((input, i) => {
      if (input.value.trim()) {
        names.push(input.value.trim());
        const hostnameInput = document.querySelectorAll('input[name="vmHostname"]')[i];
        const ipInput = document.querySelectorAll('input[name="vmIP"]')[i];
        hostnames.push(hostnameInput.value.trim());
        ips.push(ipInput.value.trim());
      }
    });
    
    formData.set('vm_names', names.join(','));
    formData.set('hostnames', hostnames.join(','));
    formData.set('vm_ips', ips.join(','));
    
    // æäº¤è¯·æ±‚
    fetch('/submit', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.details || 'è¯·æ±‚å¤±è´¥');
        });
      }
      return response.json();
    })
    .then(data => {
      hideProgress();
      showSuccess('è™šæ‹Ÿæœºéƒ¨ç½²æˆåŠŸï¼');
      
      if (data.passwords && Object.keys(data.passwords).length > 0) {
        displayPasswords(data.passwords);
      }
    })
    .catch(error => {
      hideProgress();
      showError('éƒ¨ç½²å¤±è´¥ï¼š' + error.message);
    });
  });
  
  function validateForm() {
    const strategy = document.querySelector('input[name="scheduling_strategy"]:checked').value;
    const vmCount = document.querySelectorAll('input[name="vmName"]').length;
    
    // æ£€æŸ¥VMåç§°
    const vmNames = [];
    let hasEmptyName = false;
    document.querySelectorAll('input[name="vmName"]').forEach(input => {
      if (!input.value.trim()) {
        hasEmptyName = true;
      } else {
        vmNames.push(input.value.trim());
      }
    });
    
    if (hasEmptyName) {
      showError('è¯·å¡«å†™æ‰€æœ‰è™šæ‹Ÿæœºåç§°');
      showSection('vms');
      return false;
    }
    
    // æ£€æŸ¥è°ƒåº¦ç­–ç•¥é…ç½®
    if (strategy === 'single-esxi') {
      const host = document.getElementById('single_esxi_hostname').value;
      if (!host) {
        showError('è¯·æŒ‡å®šESXiä¸»æœºåœ°å€');
        showSection('scheduling');
        return false;
      }
    } else if (strategy === 'multi-esxi') {
      const hosts = document.getElementById('multi_esxi_hostnames').value
        .split('\n').map(h => h.trim()).filter(h => h);
      if (hosts.length !== vmCount) {
        showError(`ESXiä¸»æœºæ•°é‡(${hosts.length})ä¸è™šæœºæ•°é‡(${vmCount})ä¸åŒ¹é…`);
        showSection('scheduling');
        return false;
      }
    }
    
    return true;
  }
  
  function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.className = 'alert alert-error';
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth' });
  }
  
  function showSuccess(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.className = 'alert alert-success';
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    errorDiv.scrollIntoView({ behavior: 'smooth' });
  }
  
  function showProgress() {
    const container = document.getElementById('progressContainer');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');

    container.style.display = 'flex';
    fill.style.width = '0%';
    text.textContent = '0%';

    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10 + 5;
      if (progress > 90) progress = 90;
      
      fill.style.width = progress + '%';
      text.textContent = Math.round(progress) + '%';
    }, 800);

    container.dataset.intervalId = interval;
    startLogPolling();
  }

  function hideProgress() {
    const container = document.getElementById('progressContainer');
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');
    const intervalId = container.dataset.intervalId;

    if (intervalId) {
      clearInterval(parseInt(intervalId));
    }

    stopLogPolling();
    fetchLogs(true);

    fill.style.width = '100%';
    text.textContent = '100%';

    setTimeout(() => {
      container.style.display = 'none';
    }, 1000);
  }
  
  function displayPasswords(passwords) {
    const display = document.getElementById('passwordsDisplay');
    let html = '<h3 style="margin-bottom: 1rem; color: #166534;">ğŸ‰ è™šæ‹Ÿæœºéƒ¨ç½²æˆåŠŸï¼</h3>';
    html += '<p style="margin-bottom: 1rem; color: #16a34a;">ä»¥ä¸‹æ˜¯ä¸ºæ¯å°è™šæ‹Ÿæœºç”Ÿæˆçš„éšæœºå¯†ç ï¼š</p>';
    
    for (const [vm, password] of Object.entries(passwords)) {
      html += `
        <div class="password-item">
          <div class="password-vm">${vm}</div>
          <div class="password-value">${password}</div>
        </div>
      `;
    }
    
    html += '<p style="margin-top: 1rem; font-size: 0.875rem; color: #059669;">è¯·å¦¥å–„ä¿å­˜è¿™äº›å¯†ç ï¼Œé¡µé¢åˆ·æ–°åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹ã€‚</p>';
    
    display.innerHTML = html;
    display.style.display = 'block';
    display.scrollIntoView({ behavior: 'smooth' });
  }

  function fetchLogs(forceScroll = false) {
    const logContainer = document.getElementById('logContent');
    const status = document.getElementById('logStatus');

    if (!logContainer || !status) {
      return;
    }

    status.textContent = 'æ­£åœ¨åŠ è½½æ—¥å¿—...';

    fetch('/logs')
      .then(response => {
        if (!response.ok) {
          throw new Error('è·å–æ—¥å¿—å¤±è´¥');
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          status.textContent = data.details || 'æ—¥å¿—è¯»å–å¤±è´¥';
          return;
        }

        const logs = data.logs || 'æš‚æ— æ—¥å¿—è¾“å‡º';
        logContainer.textContent = logs;

        if (forceScroll) {
          logContainer.scrollTop = logContainer.scrollHeight;
        }

        if (data.message) {
          status.textContent = data.message;
        } else {
          status.textContent = 'æœ€åæ›´æ–°: ' + new Date().toLocaleTimeString();
        }
      })
      .catch(error => {
        status.textContent = 'æ—¥å¿—è·å–å¤±è´¥: ' + error.message;
      });
  }

  function startLogPolling() {
    if (isAutoRefreshing) {
      return;
    }

    isAutoRefreshing = true;
    updateAutoRefreshButton();
    fetchLogs(true);

    logInterval = setInterval(() => {
      fetchLogs(true);
    }, 5000);
  }

  function stopLogPolling() {
    if (logInterval) {
      clearInterval(logInterval);
      logInterval = null;
    }

    isAutoRefreshing = false;
    updateAutoRefreshButton();
  }

  function toggleAutoRefresh() {
    if (isAutoRefreshing) {
      stopLogPolling();
    } else {
      startLogPolling();
    }
  }

  function updateAutoRefreshButton() {
    const btn = document.getElementById('toggleAutoRefresh');
    const status = document.getElementById('logStatus');
    if (!btn) {
      return;
    }

    if (isAutoRefreshing) {
      btn.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
      btn.classList.remove('btn-secondary');
      btn.classList.add('btn-danger');
      if (status) {
        status.textContent = 'è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯';
      }
    } else {
      btn.textContent = 'å¼€å¯è‡ªåŠ¨åˆ·æ–°';
      btn.classList.remove('btn-danger');
      btn.classList.add('btn-secondary');
      if (status) {
        status.textContent = 'è‡ªåŠ¨åˆ·æ–°å·²å…³é—­ï¼Œå¯æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹æœ€æ–°æ—¥å¿—';
      }
    }
  }

  // åˆå§‹åŒ–
  updateNavigationButtons();
  updateVmTableDisplay();
  fetchLogs(false);
</script>
</body>
</html>
