<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>虚拟机配置表单</title>
  <style>
    body { font-family: "Microsoft YaHei", sans-serif; background-color: #f6f6f6; margin: 0; padding: 0; }
    .container { max-width: 1000px; margin: 30px auto; background: #fff; padding: 20px 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 20px; }
    fieldset { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px; padding: 20px; }
    legend { font-weight: bold; padding: 0 10px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; }
    input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; outline: none; }
    textarea { height: 100px; resize: vertical; }
    .folder-input { display: flex; align-items: center; }
    .folder-input span { padding: 8px; background-color: #eee; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px; }
    .folder-input input { border-radius: 0 4px 4px 0; border-left: none; }
    input[type="checkbox"], input[type="radio"] { transform: scale(1.2); margin-right: 5px; cursor: pointer; }
    button { cursor: pointer; padding: 8px 16px; background-color: #4CAF50; border: none; border-radius: 4px; color: #fff; font-size: 14px; }
    button:hover { background-color: #45a049; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    thead tr { background-color: #f2f2f2; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
    .delete-btn { background-color: #f44336; margin-left: 10px; }
    .delete-btn:hover { background-color: #e53935; }
    .scheduling-options { display: flex; flex-direction: column; gap: 15px; }
    .scheduling-option { padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; }
    .scheduling-option.selected { border-color: #4CAF50; background: #e8f5e9; }
    .scheduling-title { font-weight: bold; margin-bottom: 8px; }
    .scheduling-desc { color: #666; font-size: 14px; margin-bottom: 10px; }
    .esxi-config { display: none; }
    .esxi-config.active { display: block; }
    .esxi-host-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }
    .esxi-host-item label { margin: 0; flex: 1; }
    .warning-box { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 10px; border-radius: 4px; margin-top: 10px; }
    .info-box { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 4px; margin-top: 10px; }
    #progressModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    #progressModal .modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; width: 300px; }
    #progressBar { width: 100%; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 10px; }
    #progressBar div { height: 20px; width: 0; background: #4caf50; text-align: center; color: #fff; line-height: 20px; }
    #errorMessage { background: #f44336; color: #fff; padding: 10px; border-radius: 4px; margin-bottom: 10px; display: none; }
    #passwordsDisplay { background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top: 10px; white-space: pre-wrap; display: none; }
  </style>
</head>
<body>
<div class="container">
  <h2>虚拟机配置表单</h2>
  <div id="errorMessage"></div>
  <form id="vmForm" method="post" action="/submit">
    <!-- vCenter 连接信息 -->
    <fieldset>
      <legend>vCenter 连接信息</legend>
      <div class="form-group"><label for="vcenter_hostname">vCenter 主机名</label><input type="text" id="vcenter_hostname" name="vcenter_hostname" required value="10.0.200.100"></div>
      <div class="form-group"><label for="vcenter_username">vCenter 用户名</label><input type="text" id="vcenter_username" name="vcenter_username" required value="administrator@vsphere.local"></div>
      <div class="form-group"><label for="vcenter_password">vCenter 密码</label><input type="text" id="vcenter_password" name="vcenter_password" required value="Leinao@323"></div>
      <div class="form-group"><label for="datacenter_name">数据中心名称</label><input type="text" id="datacenter_name" name="datacenter_name" required value="Leinao"></div>
      <div class="form-group"><label for="datastore_name">存储名称</label><select id="datastore_name" name="datastore_name" required><option value="104-ShanYan-60T">104-ShanYan-60T</option><option value="SandStone-28T">SandStone-28T</option><option value="ShanYan-SSD" selected>ShanYan-SSD</option></select></div>
      <div class="form-group"><label for="vm_folder_suffix">虚机文件夹</label><div class="folder-input"><span>/vm/</span><input type="text" id="vm_folder_suffix" name="vm_folder_suffix" required placeholder="其他" value="其他"></div></div>
    </fieldset>

    <!-- 调度策略配置 -->
    <fieldset>
      <legend>调度策略配置</legend>
      <div class="scheduling-options">
        <div class="scheduling-option selected" data-strategy="cluster">
          <input type="radio" id="strategy_cluster" name="scheduling_strategy" value="cluster" checked>
          <label for="strategy_cluster" class="scheduling-title">集群自动调度</label>
          <div class="scheduling-desc">
            由VMware vSphere根据资源使用情况自动选择最佳ESXi主机部署虚机。适用于大多数场景。
          </div>
          <div class="info-box">
            推荐：资源均衡分布，系统自动优化性能
          </div>
        </div>
        
        <div class="scheduling-option" data-strategy="single-esxi">
          <input type="radio" id="strategy_single" name="scheduling_strategy" value="single-esxi">
          <label for="strategy_single" class="scheduling-title">指定单台ESXi主机</label>
          <div class="scheduling-desc">
            将所有虚机部署到同一台ESXi主机上。适用于需要特定硬件资源的场景。
          </div>
          <div class="esxi-config" id="single-esxi-config">
            <label for="single_esxi_hostname">ESXi主机IP地址:</label>
            <input type="text" id="single_esxi_hostname" name="single_esxi_hostname" placeholder="例如: 10.0.200.28 或 192.168.7.11">
            <div class="info-box" style="margin-top: 10px;">
              <strong>常用ESXi主机参考:</strong><br>
              • CPU集群: 10.0.200.11-18<br>
              • GPU集群: 10.0.200.28-32<br>
              • T4集群: 192.168.7.11-14
            </div>
            <div class="warning-box">
              注意：所有虚机将部署到同一台主机，请确保该主机有足够的资源
            </div>
          </div>
        </div>
        
        <div class="scheduling-option" data-strategy="multi-esxi">
          <input type="radio" id="strategy_multi" name="scheduling_strategy" value="multi-esxi">
          <label for="strategy_multi" class="scheduling-title">为每个VM指定不同ESXi主机</label>
          <div class="scheduling-desc">
            为每个虚机单独指定部署的ESXi主机。适用于需要特定硬件配置（如GPU、高性能存储）的场景。
          </div>
          <div class="esxi-config" id="multi-esxi-config">
            <label>ESXi主机分配 (每行对应一个VM):</label>
            <textarea id="multi_esxi_hostnames" name="multi_esxi_hostnames" placeholder="请按VM顺序输入ESXi主机IP，每行一个，例如:&#10;10.0.200.28&#10;10.0.200.29&#10;192.168.7.11"></textarea>
            <div class="warning-box">
              重要：ESXi主机数量必须与虚机数量完全一致，按VM表格顺序对应
            </div>
          </div>
        </div>
      </div>
    </fieldset>

    <!-- 虚机信息 -->
    <fieldset>
      <legend>虚机信息</legend>
      <table id="vmTable">
        <thead>
          <tr>
            <th>序号</th>
            <th>虚机名称</th>
            <th>系统 Hostname</th>
            <th>虚机 IP</th>
            <th>ESXi主机 (多主机模式)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td><input type="text" name="vmName" placeholder="test-vm1"></td>
            <td><input type="text" name="vmHostname" placeholder="guest-hostname1"></td>
            <td><input type="text" name="vmIP" placeholder="10.0.101.190"></td>
            <td class="esxi-assignment">自动分配</td>
            <td><button type="button" class="delete-btn" onclick="deleteRow(this)">删除</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" id="addVmBtn">+ 添加虚机</button>
    </fieldset>

    <!-- 模板与硬件配置 -->
    <fieldset><legend>模板与硬件配置</legend><div class="form-group"><label for="template">模板名称</label><select id="template" name="template" required><option value="centos7.9-consul模板">centos7.9-consul模板</option><option value="openEuler22.03模板" selected>openEuler22.03模板</option><option value="ubuntu-20.04模板">ubuntu-20.04模板</option><option value="T4集群-Centos模板">T4集群-Centos模板</option></select></div><div class="form-group"><label for="num_cpus">CPU 数量</label><input type="number" id="num_cpus" name="num_cpus" required value="2"></div><div class="form-group"><label for="memory_gb">内存 (GB)</label><input type="number" id="memory_gb" name="memory_gb" required value="4"></div><div class="form-group"><label for="disk_size_gb">磁盘大小 (GB)</label><input type="number" id="disk_size_gb" name="disk_size_gb" required value="400"></div></fieldset>

    <!-- 网络配置 -->
    <fieldset><legend>网络配置</legend><div class="form-group"><label for="network_name">网络适配器名称</label><select id="network_name" name="network_name" required><option value="vlan100-生产">vlan100-生产</option><option value="vlan101-测试" selected>vlan101-测试</option><option value="vlan102-开发">vlan102-开发</option></select></div><div class="form-group"><label for="netmask">子网掩码</label><input type="text" id="netmask" name="netmask" required value="255.255.255.0"></div><div class="form-group"><label for="gateway">网关</label><input type="text" id="gateway" name="gateway" required value="10.0.101.1"></div><div class="form-group"><label for="dns_servers">DNS 服务器</label><input type="text" id="dns_servers" name="dns_servers" placeholder="223.5.5.5,8.8.8.8" value="223.5.5.5"></div></fieldset>

    <!-- 集群配置 -->
    <fieldset><legend>集群配置</legend>
      <div class="info-box">
        <strong>注意:</strong> 集群配置仅在"集群自动调度"模式下使用。指定ESXi主机时会直接部署到该主机，无需集群配置。
      </div>
      <div class="form-group"><label for="cluster">集群 (仅集群自动调度模式)</label><select id="cluster" name="cluster" required><option value="Leinao-CPU集群" selected>Leinao-CPU集群</option><option value="Leinao-GPU集群">Leinao-GPU集群</option><option value="Leinao-T4集群">Leinao-T4集群</option></select></div><div class="form-group"><label for="resource_pool">资源池 (仅集群自动调度模式)</label><input type="text" id="resource_pool" name="resource_pool" required value="Resources"></div></fieldset>

    <!-- 隐藏字段 -->
    <input type="hidden" id="vm_names" name="vm_names">
    <input type="hidden" id="vm_ips" name="vm_ips">
    <input type="hidden" id="vm_folder" name="vm_folder">
    <input type="hidden" id="esxi_hostnames" name="esxi_hostnames">
    
    <div style="text-align: center;"><button type="submit">提交配置</button></div>
  </form>
  <pre id="passwordsDisplay"></pre>
</div>

<!-- 进度条遮罩 -->
<div id="progressModal"><div class="modal-content"><h3>任务执行中...</h3><div id="progressBar"><div></div></div></div></div>

<script>
  let vmCounter = 1;
  
  // 调度策略切换
  document.querySelectorAll('input[name="scheduling_strategy"]').forEach(radio => {
    radio.addEventListener('change', function() {
      // 更新选中状态
      document.querySelectorAll('.scheduling-option').forEach(opt => opt.classList.remove('selected'));
      this.closest('.scheduling-option').classList.add('selected');
      
      // 显示/隐藏对应配置
      document.querySelectorAll('.esxi-config').forEach(config => config.classList.remove('active'));
      
      if (this.value === 'single-esxi') {
        document.getElementById('single-esxi-config').classList.add('active');
      } else if (this.value === 'multi-esxi') {
        document.getElementById('multi-esxi-config').classList.add('active');
        updateEsxiAssignmentDisplay();
      }
      
      updateVmTableDisplay();
    });
  });
  
  // 更新VM表格中ESXi主机分配显示
  function updateVmTableDisplay() {
    const strategy = document.querySelector('input[name="scheduling_strategy"]:checked').value;
    const esxiCells = document.querySelectorAll('.esxi-assignment');
    
    esxiCells.forEach((cell, index) => {
      if (strategy === 'cluster') {
        cell.textContent = '集群自动调度';
        cell.style.color = '#666';
      } else if (strategy === 'single-esxi') {
        const selectedHost = document.getElementById('single_esxi_hostname').value;
        cell.textContent = selectedHost || '待选择';
        cell.style.color = '#2196F3';
      } else if (strategy === 'multi-esxi') {
        cell.textContent = `主机${index + 1}`;
        cell.style.color = '#FF9800';
      }
    });
  }
  
  // 更新多主机模式的ESXi分配显示
  function updateEsxiAssignmentDisplay() {
    const textarea = document.getElementById('multi_esxi_hostnames');
    const hosts = textarea.value.split('\n').map(h => h.trim()).filter(h => h);
    const esxiCells = document.querySelectorAll('.esxi-assignment');
    
    esxiCells.forEach((cell, index) => {
      if (hosts[index]) {
        cell.textContent = hosts[index];
        cell.style.color = '#4CAF50';
      } else {
        cell.textContent = `主机${index + 1} (未指定)`;
        cell.style.color = '#f44336';
      }
    });
  }
  
  // 监听单ESXi主机输入变化
  document.getElementById('single_esxi_hostname').addEventListener('input', updateVmTableDisplay);
  
  // 监听多ESXi主机文本框变化
  document.getElementById('multi_esxi_hostnames').addEventListener('input', function() {
    if (document.querySelector('input[name="scheduling_strategy"]:checked').value === 'multi-esxi') {
      updateEsxiAssignmentDisplay();
    }
  });
  
  // 删除行函数
  function deleteRow(btn) {
    btn.parentNode.parentNode.remove();
    updateRowNumbers();
    updateVmTableDisplay();
  }
  
  // 更新行号
  function updateRowNumbers() {
    const rows = document.querySelectorAll('#vmTable tbody tr');
    rows.forEach((row, index) => {
      row.cells[0].textContent = index + 1;
    });
    vmCounter = rows.length;
  }
  
  // 添加VM行
  document.getElementById('addVmBtn').addEventListener('click', function() {
    vmCounter++;
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
      <td>${vmCounter}</td>
      <td><input type="text" name="vmName" placeholder="test-vm${vmCounter}"></td>
      <td><input type="text" name="vmHostname" placeholder="guest-hostname${vmCounter}"></td>
      <td><input type="text" name="vmIP" placeholder="10.0.101.${190 + vmCounter - 1}"></td>
      <td class="esxi-assignment">自动分配</td>
      <td><button type="button" class="delete-btn" onclick="deleteRow(this)">删除</button></td>
    `;
    document.querySelector('#vmTable tbody').appendChild(newRow);
    updateVmTableDisplay();
  });
  
  // 表单提交
  document.getElementById('vmForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.style.display = 'none';
    errorDiv.innerText = '';
    
    // 验证调度策略配置
    const strategy = document.querySelector('input[name="scheduling_strategy"]:checked').value;
    const vmCount = document.querySelectorAll('input[name="vmName"]').length;
    
    if (strategy === 'single-esxi') {
      const selectedHost = document.getElementById('single_esxi_hostname').value;
      if (!selectedHost) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = '请选择ESXi主机';
        return;
      }
    } else if (strategy === 'multi-esxi') {
      const hosts = document.getElementById('multi_esxi_hostnames').value
        .split('\n').map(h => h.trim()).filter(h => h);
      if (hosts.length !== vmCount) {
        errorDiv.style.display = 'block';
        errorDiv.innerText = `ESXi主机数量(${hosts.length})与虚机数量(${vmCount})不匹配`;
        return;
      }
    }
    
    const progressModal = document.getElementById('progressModal');
    progressModal.style.display = 'flex';
    const progressBar = document.getElementById('progressBar').firstElementChild;
    progressBar.style.width = '0%';
    progressBar.innerText = '0%';
    
    let progress = 0;
    const interval = setInterval(() => {
      progress = Math.min(progress + 10, 90);
      progressBar.style.width = progress + '%';
      progressBar.innerText = progress + '%';
    }, 500);
    
    const formData = new FormData(document.getElementById('vmForm'));
    
    // 处理文件夹路径
    const folderSuffix = formData.get('vm_folder_suffix');
    formData.set('vm_folder', '/vm/' + folderSuffix);
    formData.delete('vm_folder_suffix');
    
    // 处理内存单位转换
    const gb = parseInt(formData.get('memory_gb') || '0', 10);
    formData.set('memory_mb', gb * 1024);
    formData.delete('memory_gb');
    
    // 处理DNS服务器
    const dns = formData.get('dns_servers')?.trim();
    if (dns) formData.set('dns_servers', dns);
    
    // 收集VM信息
    const names = [], hostnames = [], ips = [];
    document.querySelectorAll('input[name="vmName"]').forEach((e, i) => {
      if (e.value.trim()) {
        names.push(e.value.trim());
        const hn = document.querySelectorAll('input[name="vmHostname"]')[i].value.trim();
        if (hn) hostnames.push(hn);
        const ip = document.querySelectorAll('input[name="vmIP"]')[i].value.trim();
        if (ip) ips.push(ip);
      }
    });
    
    formData.set('vm_names', names.join(','));
    formData.set('hostnames', hostnames.join(','));
    formData.set('vm_ips', ips.join(','));
    
    // 处理ESXi主机配置
    let esxiHosts = '';
    if (strategy === 'single-esxi') {
      esxiHosts = document.getElementById('single_esxi_hostname').value;
    } else if (strategy === 'multi-esxi') {
      esxiHosts = document.getElementById('multi_esxi_hostnames').value
        .split('\n').map(h => h.trim()).filter(h => h).join(',');
    }
    
    if (esxiHosts) {
      formData.set('esxi_hostnames', esxiHosts);
    }
    
    fetch(this.action, {
      method: 'POST',
      body: formData
    })
    .then(r => {
      clearInterval(interval);
      if (!r.ok) {
        return r.json().then(d => {
          throw new Error(d.details || '未知错误');
        });
      }
      return r.json();
    })
    .then(data => {
      progressBar.style.width = '100%';
      progressBar.innerText = '100%';
      
      // 显示密码列表
      const pwBlock = document.getElementById('passwordsDisplay');
      pwBlock.textContent = Object.entries(data.passwords)
        .map(([vm, p]) => vm + ': ' + p).join('\n');
      pwBlock.style.display = 'block';
      
      setTimeout(() => {
        progressModal.style.display = 'none';
      }, 1000);
    })
    .catch(err => {
      clearInterval(interval);
      progressModal.style.display = 'none';
      errorDiv.style.display = 'block';
      errorDiv.innerText = '任务执行失败：' + err.message;
    });
  });
  
  // 初始化显示
  updateVmTableDisplay();
</script>
</body>
</html>
